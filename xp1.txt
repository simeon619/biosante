cat << 'EOSshPayload' > /var/www/biosante/components/CheckoutPage.tsx
'use client';

import React, { useEffect, useRef, useState } from 'react';
import { MapPin, Phone, User, CheckCircle, Loader2, ArrowLeft, ArrowRight, Truck, Crosshair, Mail, Wallet, Banknote, Building2, Search, Info, ShieldCheck, Lock, Plus, Trash2, Home, Smartphone, MessageSquare } from 'lucide-react';
import { CartItem, DeliveryEstimate } from '../types';
import { api } from '../services/api';
import { ShippingCompany, findCompaniesByCity, getAllDestinations, ABIDJAN_AREA, isInAbidjanArea } from '../data/shippingCompanies';
import { useRouter } from 'next/navigation';
import { useCart } from '../context/CartContext';
import { useAuth } from '../context/AuthContext';
import { getPublicSettings, PublicSettings, defaultSettings, formatPhoneDisplay } from '../services/settings';

// Declare Leaflet global type
declare const L: any;
import { cn, formatCurrency, isValidIvorianPhone, formatIvorianPhone } from '@/lib/utils';
import * as fpixel from '@/lib/fpixel';
// import { useSettings } from '@/context/SettingsContext'; // Removed to avoid potential SSR crash if unused

interface CheckoutPageProps {
    cart: CartItem[];
    onBack: () => void;
    onClearCart: () => void;
}

export const CheckoutPage: React.FC<CheckoutPageProps> = (props) => {
    const { cart, onBack, onClearCart } = props;
    const { isInitialized } = useCart();
    const { user, addresses, loading: authLoading, refreshAddresses } = useAuth();
    const router = useRouter();

    // 1. All Refs
    const mapRef = useRef<any>(null);
    const mapContainerRef = useRef<HTMLDivElement>(null);
    const markerRef = useRef<any>(null);
    const addressInputRef = useRef<HTMLInputElement>(null);
    const nameInputRef = useRef<HTMLInputElement>(null);
    const phoneInputRef = useRef<HTMLInputElement>(null);
    const cityInputRef = useRef<HTMLInputElement>(null);
    const searchTimeoutRef = useRef<any>(null);

    // 2. All State
    const [deliveryMode, setDeliveryMode] = useState<'local' | 'shipping'>('local');
    const [deliverySpeed, setDeliverySpeed] = useState<'standard' | 'express'>('standard'); // standard = lendemain (1000F), express = jour même (2000F)
    const [selectedCity, setSelectedCity] = useState<string>('');
    const [citySearchQuery, setCitySearchQuery] = useState<string>('');
    const [availableCompanies, setAvailableCompanies] = useState<ShippingCompany[]>([]);
    const [selectedCompany, setSelectedCompany] = useState<ShippingCompany | null>(null);
    const [showCitySuggestions, setShowCitySuggestions] = useState(false);
    const [manualCompany, setManualCompany] = useState('');
    const [formData, setFormData] = useState({ name: '', phone: '', email: '', addressNote: '', address: '' });
    const [paymentError, setPaymentError] = useState<string | null>(null);
    const [validationError, setValidationError] = useState<string | null>(null);
    const [paymentMethod, setPaymentMethod] = useState<'cash' | 'manual' | 'wave'>('wave');
    const [manualConfirmed, setManualConfirmed] = useState(false);
    const [waveLinkSent, setWaveLinkSent] = useState(false);
    const [location, setLocation] = useState<{ lat: number, lng: number } | null>(null);
    const [orderPlaced, setOrderPlaced] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isMounted, setIsMounted] = useState(false);
    const [suggestions, setSuggestions] = useState<any[]>([]);
    const [showSuggestions, setShowSuggestions] = useState(false);
    const [saveNewAddress, setSaveNewAddress] = useState(false);
    const [settings, setSettings] = useState<PublicSettings>(defaultSettings);

    // 3. All Effects
    useEffect(() => {
        setIsMounted(true);
        if (user) {
            setFormData(prev => ({
                ...prev,
                name: user.name || '',
                phone: user.phone || '',
                email: user.email || ''
            }));

            // Auto-select default address
            const defaultAddr = addresses.find(a => a.is_default);
            if (defaultAddr && deliveryMode === 'local') {
                setFormData(prev => ({ ...prev, address: defaultAddr.address_full }));
                // We'll update map later when markers are ready
            }
        }
    }, [user, addresses, deliveryMode]);

    // Redirect if not authenticated (Auto-redirect)
    useEffect(() => {
        if (!authLoading && !user) {
            router.push('/login?redirect=/panier&reason=checkout');
        }
    }, [authLoading, user, router]);

    useEffect(() => {
        const loadSettings = async () => {
            const data = await getPublicSettings();
            setSettings(data);

            // Meta Pixel Tracking: InitiateCheckout
            if (data.fb_pixel_id && cart.length > 0) {
                fpixel.event('InitiateCheckout', {
                    content_ids: cart.map(i => i.id),
                    content_type: 'product',
                    value: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                    currency: 'XOF',
                    num_items: cart.reduce((sum, item) => sum + item.quantity, 0)
                }, data.fb_pixel_id);
            }
        };
        loadSettings();
    }, [cart.length]);

    // Core Update Logic - simplified, no dynamic fee calculation
    const updateLocation = async (lat: number, lng: number, fromMapDrag: boolean = false) => {
        try {
            if (fromMapDrag) {
                // Reverse geocode to get address
                const results = await api.searchPlaces(`${lat},${lng}`);
                if (results && results.length > 0) {
                    const address = results[0].display_name;
                    const addressIsInAbidjan = isInAbidjanArea(address);
                    if (!addressIsInAbidjan && deliveryMode === 'local') {
                        if (markerRef.current && mapRef.current) {
                            const prevLat = location?.lat || 5.3484;
                            const prevLng = location?.lng || -4.0305;
                            markerRef.current.setLatLng([prevLat, prevLng]);
                            mapRef.current.panTo([prevLat, prevLng]);
                        }
                        alert('Cette zone n\'est pas couverte par la livraison locale. Veuillez choisir "Villes de l\'Intérieur" pour les destinations hors Abidjan.');
                        return;
                    }
                    setFormData(prev => ({ ...prev, address }));
                }
            }
            setLocation({ lat, lng });
        } catch (e) {
            console.error(e);
        }
    };

    useEffect(() => {
        if (!isMounted || deliveryMode !== 'local') return;
        if (typeof L === 'undefined') {
            console.error("Leaflet is not loaded");
            return;
        }
        const timer = setTimeout(() => {
            try {
                if (mapContainerRef.current && !mapRef.current) {
                    const defaultLat = 5.3484;
                    const defaultLng = -4.0305;
                    const map = L.map(mapContainerRef.current, {
                        minZoom: 7,
                        maxZoom: 18
                    }).setView([defaultLat, defaultLng], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);
                    const customIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="w-10 h-10 bg-black rounded-full border-4 border-white shadow-xl flex items-center justify-center"><div class="w-2 h-2 bg-white rounded-full"></div></div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                    const marker = L.marker([defaultLat, defaultLng], {
                        icon: customIcon,
                        draggable: true
                    }).addTo(map);
                    marker.on('dragend', (e: any) => {
                        const { lat, lng } = e.target.getLatLng();
                        updateLocation(lat, lng, true);
                    });
                    map.on('click', (e: any) => {
                        const { lat, lng } = e.latlng;
                        marker.setLatLng([lat, lng]);
                        updateLocation(lat, lng, true);
                    });
                    mapRef.current = map;
                    markerRef.current = marker;
                    updateLocation(defaultLat, defaultLng);
                }
            } catch (err) {
                console.error("Map initialization error:", err);
            }
        }, 100);
        return () => clearTimeout(timer);
    }, [isMounted, deliveryMode]);

    // 4. Calculations
    const allDestinations = getAllDestinations();
    const subTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const totalItems = cart.reduce((acc, item) => acc + item.quantity, 0);

    // OFFRES CUMULABLES :
    // 1. Wave = -4% (toujours, quel que soit le nombre de produits)
    // 2. 2+ produits OU seuil atteint = Livraison gratuite

    const isEligibleForFreeDelivery = totalItems >= 2 || subTotal >= settings.delivery_free_threshold;
    const isWavePayment = paymentMethod === 'wave';

    // Wave discount (4%) - applies always when Wave is selected
    const waveDiscountAmount = isWavePayment ? Math.round(subTotal * 0.04 / 10) * 10 : 0;

    // Check if express delivery is available (before 15h)
    const currentHour = new Date().getHours();
    const isExpressAvailable = currentHour < 15;

    // Delivery fee calculation:
    // - Shipping mode (interior cities): 0 (customer pays transport company)
    // - Local mode with eligibility: FREE
    // - Local mode without eligibility: Standard (dynamic) or Express (dynamic + premium)
    const standardFee = settings.delivery_local_fee;
    const expressFee = Math.round(standardFee * 1.5 / 100) * 100; // 50% premium for express, rounded
    const baseDeliveryFee = deliverySpeed === 'express' ? expressFee : standardFee;
    const deliveryFee = deliveryMode === 'shipping' ? 0 : (isEligibleForFreeDelivery ? 0 : baseDeliveryFee);

    // Total = Sous-total + Livraison - Réduction Wave
    const total = Math.round(subTotal + deliveryFee - waveDiscountAmount);

    const filteredCities = citySearchQuery.length > 0
        ? allDestinations.filter(city => city.toLowerCase().includes(citySearchQuery.toLowerCase()))
        : allDestinations;

    // 5. Early Returns (MUST be after ALL hooks)
    // IMPORTANT: No hooks are allowed below this point
    if (!isMounted || !isInitialized || authLoading) {
        return (
            <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                <div className="flex flex-col items-center gap-4">
                    <Loader2 className="w-8 h-8 text-slate-400 animate-spin" />
                    <p className="text-slate-400 font-medium text-sm">Chargement...</p>
                </div>
            </div>
        );
    }



    if (!user) {
        return null; // Don't render anything while redirecting
    }

    if (cart.length === 0 && !orderPlaced) {
        return (
            <div className="min-h-screen bg-white flex flex-col items-center justify-center p-4">
                <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-6 border border-slate-100">
                    <Truck className="w-10 h-10 text-slate-200" />
                </div>
                <h2 className="text-2xl font-bold text-slate-900 mb-2">Votre panier est vide</h2>
                <p className="text-slate-500 mb-8 text-center max-w-sm">
                    Il semble que vous n'ayez pas encore ajouté de produits à votre panier. Prolongez votre vitalité en découvrant nos solutions.
                </p>
                <button
                    onClick={onBack}
                    className="flex items-center gap-2 bg-slate-900 text-white px-8 py-3.5 rounded-xl font-bold hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/10"
                >
                    <ArrowLeft className="w-5 h-5" />
                    Retour à la boutique
                </button>
            </div>
        );
    }

    // 6. Event Handlers
    const handleCitySelect = (city: string) => {
        setSelectedCity(city);
        setCitySearchQuery(city);
        setShowCitySuggestions(false);
        const companies = findCompaniesByCity(city);
        setAvailableCompanies(companies);
        setSelectedCompany(companies.length > 0 ? companies[0] : null);
    };

    const handleAddressChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const query = e.target.value;
        setFormData({ ...formData, address: query });
        if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
        if (query.length < 3) {
            setSuggestions([]);
            setShowSuggestions(false);
            return;
        }
        searchTimeoutRef.current = setTimeout(async () => {
            try {
                const results = await api.searchPlaces(query);
                const filteredResults = results.filter((place: any) => {
                    if (deliveryMode === 'local') {
                        const combinedAddress = `${place.display_name} ${place.address?.city || ''} ${place.address?.state || ''} ${place.address?.suburb || ''}`;
                        return isInAbidjanArea(combinedAddress);
                    }
                    return true;
                });
                setSuggestions(filteredResults);
                setShowSuggestions(true);
            } catch (err) {
                console.error(err);
            }
        }, 300);
    };

    const handleSuggestionClick = (place: any) => {
        const lat = parseFloat(place.lat);
        const lon = parseFloat(place.lon);
        const address = place.display_name;
        setFormData({ ...formData, address });
        setShowSuggestions(false);
        if (markerRef.current && mapRef.current) {
            markerRef.current.setLatLng([lat, lon]);
            mapRef.current.setView([lat, lon], 16);
        }
        updateLocation(lat, lon);
    };

    const handleGeolocation = () => {
        if (!navigator.geolocation) {
            alert("La géolocalisation n'est pas supportée par votre navigateur.");
            return;
        }
        navigator.geolocation.getCurrentPosition(async (position) => {
            const { latitude, longitude } = position.coords;
            try {
                const results = await api.searchPlaces(`${latitude},${longitude}`);
                if (results && results.length > 0) {
                    const address = results[0].display_name;
                    if (!isInAbidjanArea(address)) {
                        alert("Votre position actuelle semble être hors de la zone d'Abidjan. Veuillez choisir 'Villes de l'Intérieur'.");
                        return;
                    }
                }
                if (markerRef.current && mapRef.current) {
                    markerRef.current.setLatLng([latitude, longitude]);
                    mapRef.current.setView([latitude, longitude], 16);
                    updateLocation(latitude, longitude);
                }
            } catch (err) {
                console.error("Geocoding current position failed:", err);
            }
        }, (error) => {
            console.error("Geolocation error:", error);
            alert("Impossible de récupérer votre position.");
        });
    };

    const handleAddressBlur = () => {
        setTimeout(() => setShowSuggestions(false), 200);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setPaymentError(null);
        setValidationError(null);
        if (!formData.name.trim()) {
            setValidationError("Veuillez entrer votre nom complet.");
            nameInputRef.current?.focus();
            return;
        }
        if (!formData.phone.trim()) {
            setValidationError("Le numéro de téléphone est obligatoire.");
            phoneInputRef.current?.focus();
            return;
        }
        if (!isValidIvorianPhone(formData.phone)) {
            setValidationError("Veuillez entrer un numéro ivoirien valide (10 chiffres commençant par 01, 05 ou 07).");
            phoneInputRef.current?.focus();
            return;
        }
        if (deliveryMode === 'local') {
            if (!formData.address.trim() || !location) {
                setValidationError("Veuillez sélectionner votre lieu de livraison sur la carte.");
                addressInputRef.current?.focus();
                return;
            }
        } else {
            if (!selectedCity) {
                setValidationError("Veuillez sélectionner une ville de destination.");
                return;
            }
            if (availableCompanies.length > 0 && !selectedCompany && !manualCompany.trim()) {
                setValidationError("Veuillez sélectionner une compagnie de transport.");
                return;
            }
            if (availableCompanies.length === 0 && !manualCompany.trim()) {
                setValidationError("Veuillez préciser la compagnie de transport souhaitée.");
                return;
            }
        }
        setIsSubmitting(true);
        try {
            const paymentData = {
                cart,
                customer: {
                    name: formData.name,
                    phone: formData.phone,
                    email: formData.email
                },
                delivery: {
                    address: deliveryMode === 'local' ? formData.address : `${selectedCity} (Via ${manualCompany || selectedCompany?.name})`,
                    lat: location?.lat || 0,
                    lon: location?.lng || 0,
                    fee: deliveryFee,
                    addressNote: formData.addressNote,
                    shippingCompany: deliveryMode === 'shipping' ? (manualCompany || selectedCompany?.name) : undefined,
                    shippingCity: deliveryMode === 'shipping' ? selectedCity : undefined
                },
                paymentMethod,
                deliveryMode
            };

            const response = await api.initiatePayment(paymentData);

            // If saveNewAddress is checked, add it to user's profile
            if (saveNewAddress && user && location) {
                try {
                    await api.addAddress(user.id, {
                        label: `Livraison - ${new Date().toLocaleDateString('fr-FR')}`,
                        address_full: formData.address,
                        lat: location.lat,
                        lon: location.lng,
                        is_default: addresses.length === 0
                    });
                    await refreshAddresses();
                } catch (e) {
                    console.error("Failed to save address from checkout:", e);
                }
            }

            if (paymentMethod === 'manual' || paymentMethod === 'wave') {
                router.push(`/payment/${response.orderId}`);
                onClearCart();
            } else {
                // Meta Pixel Tracking: Purchase (Cash on Delivery)
                if (settings.fb_pixel_id) {
                    fpixel.event('Purchase', {
                        content_ids: cart.map(i => i.id),
                        content_type: 'product',
                        value: total,
                        currency: 'XOF',
                        num_items: cart.reduce((sum, item) => sum + item.quantity, 0)
                    }, settings.fb_pixel_id, response.orderId);
                }
                setOrderPlaced(true);
                onClearCart();
            }
        } catch (err: any) {
            console.error(err);
            setPaymentError(err.message || "Une erreur est survenue lors de la commande.");
            setIsSubmitting(false);
        }
    };

