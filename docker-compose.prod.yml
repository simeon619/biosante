version: '3.8'

services:
  # --- Infrastructure ---
  redis:
    image: redis:7-alpine
    container_name: biosante-redis
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - sv-network

  garage:
    image: dxflrs/garage:v1.0.1
    container_name: biosante-garage
    volumes:
      - garage_data:/var/lib/garage/data
      - garage_meta:/var/lib/garage/meta
      - ./garage.toml:/etc/garage.toml
    environment:
      - GARAGE_CONFIG_FILE=/etc/garage.toml
    restart: unless-stopped
    networks:
      - sv-network
    ports:
      - "4900:3900"

  crdb:
    image: cockroachdb/cockroach:v23.1.10
    container_name: biosante-crdb
    command: start-single-node --insecure
    volumes:
      - crdb_data:/cockroach/cockroach-data
    restart: unless-stopped
    networks:
      - sv-network
      # Database usually doesn't need to be on public proxy network unless accessed directly
      # Keeping it private on sv-network is safer

      # --- Application ---
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: biosante-backend
    restart: always
    env_file:
      - ./api/.env
    environment:
      - PORT=3333
      - HOST=0.0.0.0
      - NODE_ENV=production
      - DB_HOST=biosante-crdb
      - DB_PORT=26257
      - DB_USER=root
      - DB_PASSWORD=root
      - DB_DATABASE=defaultdb
      - REDIS_HOST=biosante-redis
      - REDIS_PORT=6379
      # S3 Configuration (Internal Network)
      - S3_ENDPOINT=http://biosante-garage:3900
      - S3_REGION=garage
      - S3_BUCKET=sante-vitalite-media
      # Internal Service Communication
      - HTTPSMS_API_URL=http://biosante-httpsms-api:8000
    depends_on:
      - crdb
      - redis
      - garage
    networks:
      - sv-network
    # Expose ports only if needed strictly, otherwise use internal network for Nginx
    ports:
      - "4334:3333"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://api.biosante.sublymus.com
    container_name: biosante-frontend
    restart: always
    environment:
      - NEXT_PUBLIC_API_URL=https://api.biosante.sublymus.com
      - INTERNAL_API_URL=http://biosante-backend:3333
    depends_on:
      - api
    networks:
      - sv-network
    ports:
      - "4001:3000"
    # --- 3rd Party Wrappers ---
  httpsms-api:
    build:
      context: ./external/httpsms/api
    container_name: biosante-httpsms-api
    env_file:
      - .env.httpsms
    depends_on:
      - crdb
      - redis
    restart: unless-stopped
    networks:
      - sv-network
    ports:
      - "4011:8000"

  httpsms-web:
    build:
      context: ./external/httpsms/web
    container_name: biosante-httpsms-web
    ports:
      - "4010:3000"
    environment:
      - NUXT_PUBLIC_HTTPSMS_API_URL=https://sms-api.sante-vitalite.com
    restart: unless-stopped
    networks:
      - sv-network

networks:
  sv-network:
    driver: bridge

volumes:
  redis_data:
  garage_data:
  garage_meta:
  crdb_data:
